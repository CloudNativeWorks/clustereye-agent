# PostgreSQL Promote Slave Functionality - Comprehensive Analysis

## üìã Executive Summary

ClusterEye Agent sistemi, PostgreSQL cluster ortamƒ±nda manuel slave promotion (k√∂le d√ºƒü√ºm√ºn√º master'a y√ºkseltme) i≈ülevselliƒüi saƒülamaktadƒ±r. Bu sistem 3 katmanlƒ± bir mimariye sahiptir:

1. **Frontend (React)** - Kullanƒ±cƒ± aray√ºz√º ve modal sistemi
2. **API (gRPC)** - Merkezi koordinasyon ve job y√∂netimi  
3. **Agent (Go)** - D√ºƒü√ºm seviyesinde promotion i≈ülemleri

## üèóÔ∏è Sistem Mimarisi

### 1. Frontend Katmanƒ±

**Dosya:** `clustereye_frontend/src/NodeStatusGrid.tsx`

#### Promote Slave Modal √ñzellikleri:
- **Trigger:** "Promote Slave" butonu (sadece admin kullanƒ±cƒ±lar)
- **Cluster Selection:** Hedef PostgreSQL cluster se√ßimi
- **Slave Node Selection:** Promotion i√ßin uygun slave node se√ßimi
- **Progress Tracking:** 3 adƒ±mlƒ± progress modal
- **Real-time Updates:** 3 saniye aralƒ±klarla job polling

#### Modal Workflow:
```typescript
// Modal a√ßƒ±lƒ±≈üƒ±
showPromoteSlaveModal(clusterName, nodes) 
  ‚Üí setSelectedCluster()
  ‚Üí setIsPromoteSlaveModalVisible(true)

// Promotion i≈ülemi
handlePromoteSlave()
  ‚Üí API √ßaƒürƒ±sƒ±: /api/v1/jobs/postgres/promote-master
  ‚Üí Job tracking ba≈ülatma
  ‚Üí Progress modal g√∂sterimi
```

#### Progress Steps:
1. **Step 1:** "Preparing to promote slave node"
2. **Step 2:** "Promoting slave to master"  
3. **Step 3:** "Waiting for promotion to complete"

### 2. API Katmanƒ± (gRPC)

**Ana Dosya:** `clustereye-agent/internal/reporter/reporter.go`

#### gRPC Service Methods:

##### A. PromotePostgresToMaster
```go
func (r *Reporter) PromotePostgresToMaster(
    ctx context.Context, 
    req *pb.PostgresPromoteMasterRequest
) (*pb.PostgresPromoteMasterResponse, error)
```

**Request Parameters:**
- `JobId` - Unique job identifier
- `AgentId` - Format: "agent_{hostname}"
- `NodeHostname` - Target node hostname
- `DataDirectory` - PostgreSQL data directory path
- `CurrentMasterHost` - Current master host (optional)
- `Slaves` - List of slave node information

**Response:**
- `Status` - Job status enum (PENDING, IN_PROGRESS, COMPLETED, FAILED)
- `Result` - Operation result message
- `ErrorMessage` - Error details if failed

##### B. ConvertPostgresToSlave
```go
func (r *Reporter) ConvertPostgresToSlave(
    ctx context.Context,
    req *ConvertPostgresToSlaveRequest
) (*ConvertPostgresToSlaveResponse, error)
```

**Purpose:** Eski master'ƒ± slave'e d√∂n√º≈üt√ºrme (coordination i≈ülemi)

#### Command Processing:

##### Command Format:
```
postgres_promote|data_dir|process_id|new_master_host|old_master_host|old_master_ip|slave_count|slaves_info
```

**√ñrnek:**
```
postgres_promote|/var/lib/postgresql/15/main|job_123|slave-node-2|master-node-1|192.168.1.10|2|slave-node-3:192.168.1.12
```

### 3. Agent Katmanƒ± (Core Logic)

**Ana Dosya:** `clustereye-agent/internal/collector/postgres/failover.go`

#### PostgreSQLFailoverManager

Bu sƒ±nƒ±f t√ºm failover ve promotion operasyonlarƒ±nƒ± y√∂netir:

```go
type PostgreSQLFailoverManager struct {
    cfg           *config.AgentConfig
    currentState  *FailoverState
    stateFilePath string
}
```

#### Core Methods:

##### A. PromoteToMasterWithLogger
```go
func (fm *PostgreSQLFailoverManager) PromoteToMasterWithLogger(
    dataDir string, 
    logger Logger
) error
```

**ƒ∞≈ülemler:**
1. **State Initialization:** Promotion state kaydetme
2. **Automatic Rollback Setup:** Panic durumunda otomatik rollback
3. **pg_ctl Command Execution:** `pg_ctl promote -D {dataDir}`
4. **Status Verification:** Node durumu kontrol√º (MASTER/PRIMARY)
5. **State Cleanup:** Ba≈üarƒ±lƒ± durumda state temizleme

##### B. ConvertToSlaveWithIPAndLogger
```go
func (fm *PostgreSQLFailoverManager) ConvertToSlaveWithIPAndLogger(
    dataDir, masterIP string,
    newMasterPort int,
    replUser, replPassword, pgVersion string,
    logger Logger
) error
```

**ƒ∞≈ülem Adƒ±mlarƒ±:**
1. **PostgreSQL Stop:** Service durdurma
2. **Data Directory Backup:** Mevcut data'yƒ± backup alma
3. **pg_basebackup:** Fresh backup alma (-R parametresi ile)
4. **Standby Configuration:** Otomatik standby konfig√ºrasyonu
5. **PostgreSQL Start:** Standby modunda ba≈ülatma

#### Rollback Mechanism

##### FailoverState Structure:
```go
type FailoverState struct {
    JobID              string
    StartTime          time.Time
    CurrentStep        string
    CompletedSteps     []string
    BackupPaths        map[string]string
    OriginalConfig     map[string]string
    OriginalNodeStatus string
    CanRollback        bool
    RollbackReason     string
}
```

##### Automatic Rollback Triggers:
- **Panic Recovery:** defer function ile panic yakalama
- **Error Conditions:** Critical adƒ±mlarƒ±n ba≈üarƒ±sƒ±zlƒ±ƒüƒ±
- **Timeout:** ƒ∞≈üleminin zaman a≈üƒ±mƒ±
- **Critical Steps:** `data_directory_cleaned`, `pg_basebackup_completed`, `promotion_completed`

### 4. Process Logging & Job Management

**Dosya:** `clustereye-agent/internal/reporter/process_logs.go`

#### ProcessLogger Features:
```go
type ProcessLogger struct {
    client      pb.AgentServiceClient
    agentID     string
    processID   string
    processType string
    metadata    map[string]string
}
```

**Key Methods:**
- `Start()` - Job ba≈ülatma
- `LogMessage(message)` - ƒ∞≈ülem loglarƒ±
- `AddMetadata(key, value)` - Metadata ekleme
- `Stop(status)` - Job sonlandƒ±rma

#### Job Status Tracking:
- `JOB_STATUS_PENDING`
- `JOB_STATUS_IN_PROGRESS`
- `JOB_STATUS_COMPLETED`
- `JOB_STATUS_FAILED`

## üîÑ Complete Promotion Workflow

### 1. Frontend ‚Üí API Flow

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as API
    participant AG as Agent

    U->>F: Click "Promote Slave"
    F->>F: Show Modal
    U->>F: Select Slave Node
    F->>A: POST /api/v1/jobs/postgres/promote-master
    A->>AG: gRPC PromotePostgresToMaster
    AG->>A: Response (job_id)
    A->>F: HTTP Response (job_id)
    F->>A: Poll job status (every 3s)
    A->>F: Job updates
    F->>U: Progress updates
```

### 2. Agent Internal Flow

```mermaid
flowchart TD
    A[Promotion Request] --> B[Initialize State]
    B --> C[Setup Rollback]
    C --> D[Execute pg_ctl promote]
    D --> E{Success?}
    E -->|Yes| F[Verify Master Status]
    E -->|No| G[Automatic Rollback]
    F --> H{Status OK?}
    H -->|Yes| I[Clear State & Complete]
    H -->|No| J[Wait & Retry]
    J --> H
    G --> K[Restore Original State]
    K --> L[Report Failure]
```

### 3. Coordination Process

#### Master ‚Üí Slave Conversion:
1. **Old Master Conversion:** `ConvertPostgresToSlave` √ßaƒürƒ±sƒ±
2. **Data Directory Operations:**
   - PostgreSQL stop
   - Backup creation
   - Directory cleanup
   - Fresh pg_basebackup
3. **Configuration Updates:**
   - PostgreSQL 12+: `postgresql.auto.conf` + `standby.signal`
   - PostgreSQL 11-: `recovery.conf`
4. **Service Restart:** Standby modunda ba≈ülatma

#### Other Slaves Reconfiguration:
- `ReconfigureSlaveToNewMaster` method
- Configuration files update to point new master
- Connection string updates

## üõ°Ô∏è Error Handling & Rollback

### Rollback Scenarios:

#### 1. Automatic Rollback Conditions:
- **Panic during promotion**
- **pg_ctl command failure**  
- **Service start failure**
- **Network connection issues**
- **Permission problems**

#### 2. Rollback Operations:
```go
// Rollback steps (reverse order)
for i := len(completedSteps) - 1; i >= 0; i-- {
    switch step := completedSteps[i] {
    case "postgresql_stopped":
        rollbackPostgreSQLStop()
    case "config_backup_created":
        rollbackConfigChanges()
    case "data_directory_backed_up":
        rollbackDataDirectoryChanges()
    case "standby_config_created":
        rollbackStandbyConfig()
    }
}
```

#### 3. Coordination Rollback:
- Cross-node rollback coordination
- API-level rollback signaling
- Split-brain prevention
- Metadata-based rollback requests

### Safety Mechanisms:

#### 1. State Persistence:
- **File:** `/tmp/clustereye-failover/failover-state.json`
- **Content:** Complete failover state
- **Purpose:** Recovery after crashes

#### 2. Backup Strategy:
- **Data Directory:** Full backup before operations
- **Configuration Files:** Original configs preserved
- **Retention:** Multiple timestamped backups

#### 3. Validation Checks:
- **Node Status:** Pre and post validation
- **Service Status:** PostgreSQL service health
- **Replication Status:** Streaming replication validation
- **Network Connectivity:** Master-slave connectivity tests

## üìä Monitoring & Debugging

### 1. Log Sources:
- **Frontend:** Browser console, network requests
- **API:** gRPC service logs, job processing logs
- **Agent:** Process logs, failover manager logs, PostgreSQL logs

### 2. Key Metrics:
- **Promotion Success Rate**
- **Rollback Frequency**  
- **Average Promotion Time**
- **Error Classification**

### 3. Debug Information:
```go
// Debug log √∂rneƒüi
logger.LogMessage(fmt.Sprintf("DEBUG: ConvertToSlaveWithIP adƒ±m 1 - IP adresi direkt kullanƒ±lƒ±yor: %s", masterIP))
logger.LogMessage(fmt.Sprintf("DEBUG: ConvertToSlaveWithIP adƒ±m 2 - Data directory backup/temizleme ba≈ülatƒ±lƒ±yor"))
logger.LogMessage(fmt.Sprintf("DEBUG: ConvertToSlaveWithIP adƒ±m 3 - pg_basebackup ba≈ülatƒ±lƒ±yor"))
```

## üîß Configuration Management

### PostgreSQL Version Support:
- **PostgreSQL 12+:** `postgresql.auto.conf` + `standby.signal`
- **PostgreSQL 11-:** `recovery.conf` method
- **Version Detection:** Automatic version parsing
- **Command Paths:** Multiple pg_ctl path resolution

### Service Management:
```go
// Service names tried (in order)
serviceNames := []string{
    fmt.Sprintf("postgresql@%d-main", majorVersionInt), // Ubuntu cluster
    "postgresql",                                        // Generic
    fmt.Sprintf("postgresql-%d", majorVersionInt),       // RHEL/CentOS
    "postgresql.service",                               // Explicit service
}
```

## üîç Potential Improvements

### 1. Enhanced Error Handling:
- **Detailed Error Classification**
- **Custom Rollback Strategies**
- **Network Failure Recovery**
- **Timeout Customization**

### 2. Performance Optimizations:
- **Parallel Backup Operations**
- **Incremental Backup Support**
- **Compression for Large Data Transfers**
- **Connection Pooling**

### 3. Monitoring Enhancements:
- **Real-time Metrics Dashboard**
- **Historical Promotion Analytics** 
- **Predictive Failure Detection**
- **Automated Health Checks**

### 4. Configuration Flexibility:
- **Configurable Timeouts**
- **Custom pg_ctl Paths**
- **Backup Retention Policies**
- **Network Interface Selection**

## üéØ Conclusion

ClusterEye Agent'ƒ±n PostgreSQL Promote Slave functionality'si, enterprise-grade bir failover sistemi sunar. Sistem:

‚úÖ **Robust Error Handling:** Comprehensive rollback mechanisms  
‚úÖ **Cross-platform Support:** Multiple PostgreSQL versions and OS  
‚úÖ **State Management:** Persistent state for crash recovery  
‚úÖ **Real-time Monitoring:** Process logging and job tracking  
‚úÖ **Coordination Support:** Multi-node failover coordination  
‚úÖ **User-friendly Interface:** Intuitive frontend modal system  

Sistem production kullanƒ±mƒ±na hazƒ±r durumda olup, high-availability PostgreSQL cluster'larƒ± i√ßin g√ºvenilir bir failover √ß√∂z√ºm√º saƒülamaktadƒ±r.